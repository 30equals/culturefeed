<?php

module_load_include('inc', 'entry_api_ui', 'includes/entry_api_ui.helpers');

/**
 * Implements hook_permission().
 */
function entry_api_ui_permission() {
  return array(
    'manage object tags' => array(
      'title' => t('Manage object tags'),
      'description' => t('Manage all the tags from the objects on culturefeed (events, actors, ...).'),
    ),
    'manage lifestyle profile tags' => array(
      'title' => t('Manage lifestyle profile tags'),
      'description' => t('Manage the lifestyle profile tags from the objects on culturefeed (events, actors, ...).'),
    ),
    'create culturefeed events' => array(
      'title' => t('Create events'),
      'description' => t('Create new events through the entity api.'),
    ),
    'edit culturefeed events' => array(
      'title' => t('Edit events'),
      'description' => t('Edit events through the entity api.'),
    ),
    'delete culturefeed events' => array(
      'title' => t('Delete events'),
      'description' => t('Delete events through the entity api.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function entry_api_ui_menu() {

  $items = array();

  $items['entryapi/event/%entry_api_event/tags'] = array(
    'title' => 'Tags',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('entry_api_ui_edit_tags_form', 2),
    'access callback' => 'entry_api_ui_manage_tags_access',
    'file' => 'includes/entry_api_ui.pages.inc',
  );

  $items['entryapi/event/add'] = array(
    'title' => 'Event toegevoegen',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('entry_api_ui_event_form'),
    'access arguments' => array('create culturefeed events'),
    'file' => 'includes/entry_api_ui.pages.inc',
  );

  $items['entryapi/event/%entry_api_event/edit'] = array(
    'title' => 'Event aanpassen',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('entry_api_ui_event_form', 2),
    'access arguments' => array('edit culturefeed events'),
    'file' => 'includes/entry_api_ui.pages.inc',
  );

  $items['entryapi/event/%entry_api_event/delete'] = array(
    'title' => 'Event verwijderen',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('entry_api_ui_delete_event_form', 2),
    'access arguments' => array('delete culturefeed events'),
    'file' => 'includes/entry_api_ui.pages.inc',
  );

  $items['entryapi'] = array(
    'title' => 'entryapi',
    'page callback' => 'entry_api_ui_page',
    'access callback' => TRUE
  );

  return $items;

}

/**
 * Implements hook_menu_local_tasks_alter().
 */
function entry_api_ui_menu_local_tasks_alter(&$data, $router_item, $root_path) {

  if (user_access('manage object tags')) {

    $node = menu_get_object();
    $id = '';
    if ($node && isset($node->id)) {
      $id = $node->id;
    }

    $link = array(
      'href' => 'entryapi/event/' . $id . '/tags',
      'localized_options' => array(),
      'title' => 'Tags',
    );

    $data['tabs'][0]['output'][] = array('#theme' => 'menu_local_action', '#link' => $link);

  }

  if (user_access('manage object tags')) {

    $node = menu_get_object();
    $id = '';
    if ($node && isset($node->id)) {
      $id = $node->id;
    }

    $link = array(
      'href' => 'entryapi/event/' . $id . '/tags',
      'localized_options' => array(),
      'title' => 'Tags',
    );

    $data['tabs'][0]['output'][] = array('#theme' => 'menu_local_action', '#link' => $link);

  }

  $data['tabs'][0]['count'] = count($data['tabs'][0]['output']);

}

/**
 * Load an event on the entry api.
 */
function entry_api_event_load($id) {

  static $events = array();
  if (isset($events[$id])) {
    return $events[$id];
  }

  try {
    $events[$id] = DrupalCultureFeed_EntryApi::getEvent($id);
    return $events[$id];
  }
  catch (Exception $e) {
    watchdog_exception(WATCHDOG_ERROR, $e);
  }

  $events[$id] = FALSE;

  return FALSE;

}

/**
 * Access callback, to check if a user has access to the manage tags screen.
 */
function entry_api_ui_manage_tags_access() {
  return user_access('manage lifestyle profile tags') || user_access('manage object tags');
}
