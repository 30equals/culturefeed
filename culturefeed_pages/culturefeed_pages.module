<?php
/**
 * @file
 * CultureFeed Pages makes it possible to view / manage pages.
 */

module_load_include('inc', 'culturefeed_pages', 'includes/helpers');

/**
 * Implements hook_permission().
 */
function culturefeed_pages_permission() {

  return array(
    'join culturefeed page' => array(
      'title' => t('Join a culturefeed page'),
    ),
    'add culturefeed page' => array(
      'title' => t('Add a culturefeed page'),
    ),
    'edit culturefeed page' => array(
      'title' => t('Edit a culturefeed page'),
    ),
    'switch culturefeed pages' => array(
      'title' => t('Switch to another culturefeed page'),
    ),
  );

}

/**
 * Implements hook_theme().
 */
function culturefeed_pages_theme() {

  $path = drupal_get_path('module', 'culturefeed_pages') . '/theme';

  return array(

    'culturefeed_pages_join_page' => array(
      'variables' => array(
        'form' => NULL,
        'result' => NULL,
        'search' => '',
      ),
      'path' => $path,
      'file' => 'theme.inc',
      'template' => 'culturefeed-pages-join-page',
    ),

    'culturfeed_pages_join_search_result_item' => array(
      'variables' => array('item' => NULL),
      'path' => $path,
      'file' => 'theme.inc',
      'template' => 'culturefeed-pages-join-search-result-item',
    ),

    'culturefeed_page' => array(
      'variables' => array('page' => NULL),
      'path' => $path,
      'file' => 'theme.inc',
      'template' => 'culturefeed-page',
    ),

    'culturefeed_page_invisible' => array(
      'variables' => array('page' => NULL),
      'path' => $path,
      'file' => 'theme.inc',
      'template' => 'culturefeed-page-invisible',
    ),

    'culturefeed_pages_fellow_members_block' => array(
      'variables' => array(
        'account' => NULL,
        'page' => NULL,
        'members' => array(),
      ),
      'path' => $path,
      'file' => 'theme.inc',
      'template' => 'culturefeed-pages-fellow-members-block',
    ),

    'culturefeed_pages_following_pages_block' => array(
      'variables' => array('following' => array()),
      'path' => $path,
      'file' => 'theme.inc',
    ),
    
    'culturefeed_pages_block_admin_options' => array(
      'variables' => array(
        'admin_menu' => NULL,
        'is_page_admin' => FALSE,
        'logged_in_as_page_admin' => FALSE,
        'account' => NULL,
        'page' => NULL,
      ),
      'path' => $path,
      'file' => 'theme.inc',
      'template' => 'culturefeed-pages-block-admin-options',
    ),

    'culturefeed_pages_page_menu_item' => array(
      'variables' => array('title' => '', 'url' => '', 'description' => ''),
      'template' => 'culturefeed-pages-page-menu-item',
      'path' => $path,
      'file' => 'theme.inc',
    ),

  );

}

/**
 * Implements hook_menu().
 */
function culturefeed_pages_menu() {

  $items = array();

  $items['pages/join'] = array(
    'title callback' => 'culturefeed_pages_join_title',
    'page callback' => 'culturefeed_pages_join_page_search',
    'access arguments' => array('join culturefeed page'),
    'file' => 'includes/pages.inc',
  );

  $items['pages/add'] = array(
    'title' => 'Maak je eigen pagina',
    'title callback' => FALSE,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('culturefeed_pages_add_form'),
    'access arguments' => array('add culturefeed page'),
    'file' => 'includes/pages.inc',
  );

  $items['agenda/g/%/%culturefeed_pages_page'] = array(
    'title callback' => 'culturefeed_pages_detail_title',
    'title arguments' => array(3),
    'page callback' => 'culturefeed_pages_detail_page',
    'page arguments' => array(3),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/pages.inc',
  );

  $items['pages/%culturefeed_pages_page/edit'] = array(
    'title callback' => 'culturefeed_pages_detail_title',
    'title arguments' => array(1, 'edit'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('culturefeed_pages_edit_page_form', 1),
    'access callback' => 'culturefeed_pages_edit_page_access',
    'access arguments' => array(1),
    'type' => MENU_CALLBACK,
    'file' => 'includes/pages.inc',
  );

  $items['pages/%culturefeed_pages_page/remove'] = array(
    'title callback' => FALSE,
    'title' => 'Pagina verwijderen',
    'page callback' => 'culturefeed_pages_remove_page_confirm',
    'page arguments' => array(1),
    'access callback' => 'culturefeed_pages_edit_page_access',
    'access arguments' => array(1),
    'type' => MENU_CALLBACK,
    'file' => 'includes/pages.inc',
  );

  $items['pages/%culturefeed_pages_page/publish'] = array(
    'title callback' => FALSE,
    'title' => 'Pagina verwijderen',
    'page callback' => 'culturefeed_pages_publish_page_confirm',
    'page arguments' => array(1),
    'access callback' => 'culturefeed_pages_edit_page_access',
    'access arguments' => array(1),
    'type' => MENU_CALLBACK,
    'file' => 'includes/pages.inc',
  );

  $items['pages/%culturefeed_pages_page/configuration'] = array(
    'title callback' => 'culturefeed_pages_detail_title',
    'title arguments' => array(1, 'edit'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('culturefeed_pages_configuration_page_form', 1),
    'access callback' => 'culturefeed_pages_edit_page_access',
    'access arguments' => array(1),
    'type' => MENU_CALLBACK,
    'file' => 'includes/pages.inc',
  );

  $items['pages/switch/%culturefeed_pages_page'] = array(
    'title' => 'Switch to another page',
    'page callback' => 'culturefeed_pages_switch_page',
    'page arguments' => array(2),
    'access arguments' => array('switch culturefeed pages'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/pages.inc',
  );

  $items['ajax/culturefeed/pages/page-suggestion'] = array(
    'page callback' => 'culturefeed_pages_page_suggestion_autocomplete_page',
    'page arguments' => array(4),
    'access arguments' => array('join culturefeed page'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/pages.inc',
  );

  $items['ajax/culturefeed/pages/region-suggestion'] = array(
    'page callback' => 'culturefeed_pages_region_suggestion_autocomplete_page',
    'page arguments' => array(4),
    'access arguments' => array('add culturefeed page'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/pages.inc',
  );

  $items['culturefeed/pages/join/%/%culturefeed_pages_page'] = array(
    'page callback' => 'culturefeed_pages_page_join',
    'page arguments' => array(3, 4),
    'access arguments' => array('join culturefeed page'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/pages.inc',
  );

  return $items;

}

/**
 * Implements hook_block_info().
 */
function culturefeed_pages_block_info() {

  $blocks = array();

  $blocks['user-fellow-members'] = array(
    'info' => t('Fellow members from user'),
    'cache' => DRUPAL_NO_CACHE,
  );

  $blocks['pages-user-follows'] = array(
    'info' => t("Pages i'm following"),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );

  $blocks['pages-admin-options'] = array(
    'info' => t("Page options"),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );

  $blocks['pages-admin-menu'] = array(
    'info' => t("Page admin menu"),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );

  return $blocks;

}

/**
 * Implements hook_block_view().
 */
function culturefeed_pages_block_view($delta) {

  module_load_include('inc', 'culturefeed_pages', 'includes/blocks');

  switch ($delta) {

    case 'user-fellow-members':
      $account = menu_get_object('user');
      return culturefeed_pages_block_fellow_members($account);

    case 'pages-user-follows':
      $account = menu_get_object('user');
      return culturefeed_pages_block_pages_user_follows($account);
    break;

    case 'pages-admin-options':
      return culturefeed_pages_block_pages_admin_options();
    break;

    case 'pages-admin-menu':
      return culturefeed_pages_block_pages_admin_menu();
    break;

  }

}

/**
 * Implements hook_culturefeed_ui_profile_box_dropdown_items().
 */
function culturefeed_pages_culturefeed_ui_profile_box_dropdown_items($cultureFeedUser) {

  $items = array();

  if ($cultureFeedUser->adminPagesCount > 0) {

    $items['my-page'] = array(
      'data' => 'Mijn pagina',
      'class' => 'my-page',
      'children' => array(
        array('data' => 'Zoek jouw school')
      ),
      'weight' => -19,
    );
    
    if (user_access('switch culturefeed pages')) {
      
      $items['switch-page'] = array(
        'data' => 'Wijzig actieve pagina',
        'class' => 'switch-page',
        'children' => array(),
        'weight' => -18,
      );
      
      $adminMemberships = $cultureFeedUser->getMembershipsByRole(CultureFeed_Pages_Membership::MEMBERSHIP_ROLE_ADMIN);
      foreach ($adminMemberships as $membership) {
        $items['switch-page']['children'][] = array('data' => l($membership->page->getName(), 'pages/switch/' . $membership->page->getId()));
      }
    }
    
  }

  return $items;

}

/**
 * Load a culturefeed page.
 */
function culturefeed_pages_page_load($id) {

  static $pages = array();

  if (isset($pages[$id])) {
    return $pages[$id];
  }

  try {

    $cf_pages = DrupalCultureFeed::getConsumerInstance()->pages();
    $pages[$id] = $cf_pages->getPage($id);
    return $pages[$id];

  }
  catch (Exception $e) {
    watchdog_exception('culturefeed_pages', $e);
  }

  return FALSE;

}

/**
 * Title callback for the join page.
 */
function culturefeed_pages_join_title() {
  return format_string('Jouw pagina op @sitename', array('@sitename' => variable_get('site_name')));
}

/**
 * Title callback for the 'page' detail page.
 */
function culturefeed_pages_detail_title($page, $op = 'view') {
  if ($op == 'view') {
    return $page->getName();
  }
  else {
    $title = $page->getName();
    
    $address = $page->getAddress();
    if (!empty($address)) {
      $title .= ' - ' . $address->getCity();
    }
    
    return $title;
  }
}

/**
 * Access callback to indicate whether the current has can administer
 * the page.
 * @param CultureFeed_Cdb_Item_Page $page
 */
function culturefeed_pages_edit_page_access($page) {

  if (!user_access('edit culturefeed page')) {
    return FALSE;
  }

  $cultureFeedUser = DrupalCultureFeed::getLoggedInUser();
  
  // Calculate the number of pages where the current user is ADMIN.
  if ($cultureFeedUser->adminPagesCount > 0) {
    $adminMemberships = $cultureFeedUser->getMembershipsByRole(CultureFeed_Pages_Membership::MEMBERSHIP_ROLE_ADMIN);
  }
  
  // Check the current page against the current active admin page.
  return in_array($page->getId(), array_keys($adminMemberships))
      && $page->getId() === culturefeed_pages_get_active_page_id()
      && culturefeed_pages_view_page_access();
  
}

/**
 * Access callback to indicate whether the current user can see the page
 * @param CultureFeed_Cdb_Item_Page $page
 */
function culturefeed_pages_view_page_access($page) {
  return $page->isVisible();
}

/**
 * Implements hook_culturefeed_ui_profile_box_nick_alter().
 * @param unknown_type $culture_feed_profile_name
 */
function culturefeed_pages_culturefeed_ui_profile_box_nick_alter(&$culture_feed_profile_name) {
  
  $active_page = culturefeed_pages_get_active_page();
  
  if (isset($active_page)) {
    // Extend the current nickname.
    $nick = $culture_feed_profile_name['nick'] . ' van ' . $active_page->getName();
    // Create a new link for the same properties.
    $culture_feed_profile_name['link'] = l($nick, 'user/' . $culture_feed_profile_name['uid']);
  }
  
}
